---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import OurStory from '../components/OurStory.astro';
import MenuPreview from '../components/MenuPreview.astro';
import SocialMedia from '../components/SocialMedia.astro';
import Newsletter from '../components/Newsletter.astro';
import Footer from '../components/Footer.astro';
import { getMenuItems, getSiteSettings } from '../lib/strapi';

let menuItems = [];
let siteSettings = null;

try {
  [menuItems, siteSettings] = await Promise.all([
    getMenuItems(),
    getSiteSettings()
  ]);
} catch (error) {
  console.error('Failed to fetch content:', error);
  // Fallback data for when Strapi is not available
  menuItems = [
    { id: 1, name: 'Cà Phê Sữa Đá', slug: 'ca-phe-sua-da', type: 'drink', price: 5.50 },
    { id: 2, name: 'Bạc Xỉu', slug: 'bac-xiu', type: 'drink', price: 5.50 },
    { id: 3, name: 'Egg Coffee', slug: 'egg-coffee', type: 'drink', price: 7.00 },
    { id: 4, name: 'Bánh Mì Sliders', slug: 'banh-mi-sliders', type: 'bite', price: 12.00 },
  ];
}

// Get first 4 items for preview
const previewItems = menuItems.slice(0, 4);

// Dynamic page metadata
const pageTitle = siteSettings?.siteName
  ? `${siteSettings.siteName} | ${siteSettings.address || 'Nashville, TN'}`
  : 'Em & Me Vietnamese Cafe & Bites | Nashville, TN';
const pageDescription = siteSettings?.tagline
  ? `${siteSettings.tagline} Authentic Vietnamese coffee and bites in ${siteSettings.address || 'Nashville, Tennessee'}.`
  : 'Rooted in Family, Served with Love. Authentic Vietnamese coffee and bites in Nashville, Tennessee.';
---

<Layout title={pageTitle} description={pageDescription}>
  <main>
    <Header
      siteName={siteSettings?.siteName}
      tagline={siteSettings?.tagline}
      address={siteSettings?.address}
    />

    <div class="content-grid">
      <div class="left-column">
        <OurStory text={siteSettings?.ourStoryText} />
        <SocialMedia
          instagramUrl={siteSettings?.instagramUrl}
          tiktokUrl={siteSettings?.tiktokUrl}
          facebookUrl={siteSettings?.facebookUrl}
          address={siteSettings?.address}
        />
      </div>

      <div class="right-column">
        <MenuPreview items={previewItems} />
        <Newsletter />
      </div>
    </div>

    <Footer
      siteName={siteSettings?.siteName}
      tagline={siteSettings?.tagline}
    />
  </main>
</Layout>

<style>
  main {
    min-height: 100vh;
  }

  .content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-xl);
    max-width: var(--max-width);
    margin: 0 auto;
    padding: var(--spacing-lg);
  }

  .left-column,
  .right-column {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xl);
  }

  @media (max-width: 900px) {
    .content-grid {
      grid-template-columns: 1fr;
    }

    .left-column {
      order: 2;
    }

    .right-column {
      order: 1;
    }
  }
</style>
