---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getMenuItems, getMenuItemBySlug, getSiteSettings, STRAPI_URL } from '../../lib/strapi';
import type { MenuItem } from '../../lib/strapi';

export async function getStaticPaths() {
  const menuItems = await getMenuItems();
  return menuItems.map((item) => ({
    params: { slug: item.slug },
  }));
}

const { slug } = Astro.params;
let menuItem: MenuItem | null = null;
let siteSettings = null;

try {
  [menuItem, siteSettings] = await Promise.all([
    getMenuItemBySlug(slug as string),
    getSiteSettings()
  ]);
} catch (error) {
  console.error('Failed to fetch content:', error);
}

if (!menuItem) {
  return Astro.redirect('/menu');
}

const pageTitle = siteSettings?.siteName
  ? `${menuItem.name} | ${siteSettings.siteName}`
  : `${menuItem.name} | Em & Me Vietnamese Cafe & Bites`;

// Placeholder images
const placeholderImages: Record<string, string> = {
  'ca-phe-sua-da': 'https://images.unsplash.com/photo-1514432324607-a09d9b4aefdd?w=600&h=400&fit=crop',
  'bac-xiu': 'https://images.unsplash.com/photo-1485808191679-5f86510681a2?w=600&h=400&fit=crop',
  'egg-coffee': 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=600&h=400&fit=crop',
  'banh-mi-sliders': 'https://images.unsplash.com/photo-1600688640154-9619e002df30?w=600&h=400&fit=crop',
  'pho-bo': 'https://images.unsplash.com/photo-1582878826629-29b7ad1cdc43?w=600&h=400&fit=crop',
  'goi-cuon': 'https://images.unsplash.com/photo-1544025162-d76694265947?w=600&h=400&fit=crop',
  'tra-da': 'https://images.unsplash.com/photo-1556679343-c7306c1976bc?w=600&h=400&fit=crop',
};

function getImageUrl(item: MenuItem): string {
  if (item.image?.url) {
    return item.image.url.startsWith('http') ? item.image.url : `${STRAPI_URL}${item.image.url}`;
  }
  return placeholderImages[item.slug] || 'https://via.placeholder.com/600x400?text=Menu+Item';
}

function formatPrice(price: number): string {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(price);
}

function getTypeLabel(type: string): string {
  switch (type) {
    case 'drink': return 'Drink';
    case 'bite': return 'Bite';
    default: return 'Other';
  }
}
---

<Layout title={pageTitle}>
  <main>
    <Header
      siteName={siteSettings?.siteName}
      tagline={siteSettings?.tagline}
      address={siteSettings?.address}
    />

    <section class="menu-item-section">
      <div class="menu-item-container">
        <div class="menu-item-image">
          <img
            src={getImageUrl(menuItem)}
            alt={menuItem.name}
            loading="eager"
          />
        </div>

        <div class="menu-item-details">
          <span class="menu-item-type">{getTypeLabel(menuItem.type)}</span>
          <h1 class="menu-item-name">{menuItem.name}</h1>

          {menuItem.description && (
            <p class="menu-item-description">{menuItem.description}</p>
          )}

          <p class="menu-item-price">{formatPrice(menuItem.price)}</p>

          {!menuItem.available && (
            <p class="menu-item-unavailable">Currently Unavailable</p>
          )}
        </div>
      </div>

      <div class="back-links">
        <a href="/menu" class="btn btn-outline">Back to Menu</a>
        <a href="/" class="btn btn-outline">Back to Home</a>
      </div>
    </section>

    <Footer
      siteName={siteSettings?.siteName}
      tagline={siteSettings?.tagline}
    />
  </main>
</Layout>

<style>
  .menu-item-section {
    max-width: 800px;
    margin: 0 auto;
    padding: var(--spacing-xl) var(--spacing-lg);
  }

  .menu-item-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-xl);
    background: white;
    border: 2px solid var(--color-navy);
    border-radius: 12px;
    overflow: hidden;
  }

  .menu-item-image {
    aspect-ratio: 4/3;
    overflow: hidden;
  }

  .menu-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .menu-item-details {
    padding: var(--spacing-lg);
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .menu-item-type {
    display: inline-block;
    background: var(--color-navy);
    color: var(--color-cream);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: var(--spacing-md);
    width: fit-content;
  }

  .menu-item-name {
    font-size: 2rem;
    color: var(--color-navy);
    margin-bottom: var(--spacing-md);
  }

  .menu-item-description {
    font-size: 1.1rem;
    color: var(--color-text);
    line-height: 1.6;
    margin-bottom: var(--spacing-lg);
  }

  .menu-item-price {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-navy);
  }

  .menu-item-unavailable {
    color: #dc3545;
    font-weight: 500;
    margin-top: var(--spacing-sm);
  }

  .back-links {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    margin-top: var(--spacing-xl);
  }

  @media (max-width: 768px) {
    .menu-item-container {
      grid-template-columns: 1fr;
    }

    .menu-item-image {
      aspect-ratio: 16/10;
    }

    .menu-item-name {
      font-size: 1.5rem;
    }

    .back-links {
      flex-direction: column;
      align-items: center;
    }
  }
</style>
